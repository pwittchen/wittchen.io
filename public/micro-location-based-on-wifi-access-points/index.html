<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Micro-location based on WiFi Access Points · Piotr Wittchen</title><meta name="description" content="Micro-location based on WiFi Access Points - Piotr Wittchen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400"><link rel="search" type="application/opensearchdescription+xml" href="http://wittchen.io/atom.xml" title="Piotr Wittchen"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><div>Piotr Wittchen</div></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">WRITING</a></li><li class="nav-list-item"><a href="/code" target="_self" class="nav-list-link">CODE</a></li><li class="nav-list-item"><a href="/projects" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="/talks" target="_self" class="nav-list-link">TALKS</a></li><li class="nav-list-item"><a href="/contact" target="_self" class="nav-list-link">CONTACT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Micro-location based on WiFi Access Points</h1><div class="post-info">Sep 21, 2014</div><div class="post-content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Recently, I started working on quite interesting project. One of its elements is micro-location inside the building based on WiFi Access Points. Company’s buildings have a lot of Access Points in different locations like regular rooms, conference rooms, corridors, sports building and restaurant. Having pool of Access Points with their names, locations and <a href="http://en.wikipedia.org/wiki/MAC_address" target="_blank" rel="noopener">MAC</a> addresses (or more precisely: <a href="http://en.wiktionary.org/wiki/BSSID" target="_blank" rel="noopener">BSSID</a>) it’s possible to create micro-location for Android mobile devices.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>On the image below, you can see approximate location of WiFi Access Points in the F3 building of Future Processing company. Other buildings also have their own Access Points, but they weren’t taken into consideration during the initial experiment. Android gives us possibility to scan available WiFi Access Points and measure their signal strength. Appropriate <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html" target="_blank" rel="noopener">BroadcastReceiver</a> allows us to react on event of changing WiFi Access Points signal strength, what can be interpreted as movement of person having mobile device. When such event occurs, we can read list of available Access Points, measure their signal strength, detect Access Point with the strongest signal, map it to specific room location and start WiFi scan again in order to retrieve fresh list of the Access Points as soon as possible. We have to remember that WiFi scanning is an asynchronous operation, so we don’t know, when we receive the results. That’s why event-driven development is good approach in such case. We can use pure Android BroadcastReceiver or use <a href="http://square.github.io/otto/" target="_blank" rel="noopener">Otto Event Bus</a> to make our code annotation-based, fine-grained and clear. </p>
<p><img src="/images/posts/2014/micro-location-based-on-wifi-access-points/fp-buildings-hot-spots.png" alt="fp-buildings-hot-spots"> </p>
<p><em>Original image comes from <a href="http://www.future-processing.com" target="_blank" rel="noopener">www.future-processing.com</a> website.</em></p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>To implement micro-location I used open-source <a href="https://github.com/pwittchen/NetworkEvents" target="_blank" rel="noopener">NetworkEvents</a> Android library, which I have written earlier and described in <a href="http://blog.wittchen.biz.pl/networkevents-android-library/" target="_blank" rel="noopener">one of my previous blog posts</a>. First, we should create <code>AccessPoint</code> model. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessPoint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String mac;</span><br><span class="line">    <span class="keyword">private</span> String keyName;</span><br><span class="line">    <span class="keyword">private</span> String fineName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccessPoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccessPoint</span><span class="params">(String mac, String keyName, String fineName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mac = mac;</span><br><span class="line">        <span class="keyword">this</span>.keyName = keyName;</span><br><span class="line">        <span class="keyword">this</span>.fineName = fineName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMac</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mac;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKeyName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> keyName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFineName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fineName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AccessPoint</code> class can cotain <code>mac</code> address of the particular Access Point, <code>keyName</code> as additional identifier of the Access Point location and <code>fineName</code> containing readable name of the Access Point location, which can be displayed for the user. After that, we have to create <code>RoomLocator</code> class. This class contains <code>getNearestAccessPoint()</code> method, which reads list of the available Access Points and returns one with the strongest signal. We have to remember, that <strong>we have to fill</strong> <code>accessPointsRoomList</code> <strong>HashMap with our map of the Access Points</strong>. In this case, MAC address of the Access Point, which is String value, should be treated as a key in the HashMap. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoomLocator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, AccessPoint&gt; accessPointsRoomList = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccessPoint <span class="title">getNearestAccessPoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        WifiManager wifiManager = (WifiManager) context.getSystemService(Context.WIFI_SERVICE);</span><br><span class="line">        List&lt;ScanResult&gt; accessPointsScanResult = wifiManager.getScanResults();</span><br><span class="line">        AccessPoint nearestAccessPoint = <span class="keyword">null</span>;</span><br><span class="line">        ScanResult bestSignal = <span class="keyword">null</span>;</span><br><span class="line">        String currentNearestBSSID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ScanResult scanResult : accessPointsScanResult) &#123;</span><br><span class="line">            currentNearestBSSID = scanResult.BSSID.toUpperCase();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!accessPointsRoomList.containsKey(currentNearestBSSID)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bestSignal == <span class="keyword">null</span> || WifiManager.compareSignalLevel(bestSignal.level, scanResult.level) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                nearestAccessPoint = accessPointsRoomList.get(currentNearestBSSID);</span><br><span class="line">                bestSignal = scanResult;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> nearestAccessPoint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After that, we can use <a href="https://github.com/pwittchen/NetworkEvents" target="_blank" rel="noopener">NetworkEvents</a> to listen, when signal strength of the Access Points is being changed. This usually happens, when user is moving with the smartphone. We can do that very easily with <code>@Subscribe</code> annotation. When mentioned event occurs, we can call <code>getNearestAccessPoint()</code> method from <code>RoomLocator</code> class. Of course, we can create provider for this class and access it in static way. In addition, please read <a href="http://blog.wittchen.biz.pl/networkevents-android-library/" target="_blank" rel="noopener">my previous post about Network Events</a> library if you want to know, how to use it properly. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wifiAccessPointsRefreshed</span><span class="params">(WifiAccessPointsSignalStrengthChangedEvent event)</span> </span>&#123;</span><br><span class="line">   AccessPoint accessPoint = <span class="keyword">new</span> RoomLocator().getNearestAccessPoint();</span><br><span class="line">   Toast.makeText(<span class="keyword">this</span>, accessPoint.getFineName(), Toast.LENGTH_SHORT).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That’s it. Every time, when <code>WifiAccessPointsSignalStrengthChangedEvent</code> will occur, you will get fresh information about Access Point with the strongest signal, which can be treated as your location. I’ve tested this solution and it actually works. Please remember that such application can work only in buildings with many different Access Points in different rooms on different floors (usually in IT companies).</p>
</div></article></div></main><footer><div class="paginator"><a href="/weather-icons-for-android-applications/" class="prev">PREV</a><a href="/versioning-android-applications/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'wittchenio';
var disqus_identifier = 'micro-location-based-on-wifi-access-points/';
var disqus_title = 'Micro-location based on WiFi Access Points';
var disqus_url = 'http://wittchen.io/micro-location-based-on-wifi-access-points/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//undefined.disqus.com/count.js" async></script><div class="copyright"><p>© 2013 - 2019 <a href="http://wittchen.io">Piotr Wittchen</a></p><p><a href="https://github.com/pwittchen/wittchen.io" target="_blank" rel="noopener">source</a> / <a href="/feed.xml">rss</a> / <a href="/archives">archives</a> / <a href="/tags">tags</a> / <a href="https://github.com/pwittchen/wittchen.io#rest" target="_blank" rel="noopener">api</a> / <a href="/gh">github</a> / <a href="/so">stackoverflow</a> / <a href="/in">linkedin</a> / <a href="mailto:piotr@wittchen.io">email</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-2194664-7",'auto');ga('send','pageview');</script></body></html>