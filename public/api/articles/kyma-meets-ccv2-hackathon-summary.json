{"title":"Kyma meets CCV2 hackathon summary","slug":"kyma-meets-ccv2-hackathon-summary","date":"2018-12-14T13:34:01.000Z","updated":"2019-07-03T22:51:02.813Z","comments":true,"path":"api/articles/kyma-meets-ccv2-hackathon-summary.json","excerpt":null,"covers":["/images/posts/2018/kyma-meets-ccv2-hackathon-summary/clickr_frontend.png","/images/posts/2018/kyma-meets-ccv2-hackathon-summary/clickr_frontend2.png","/images/posts/2018/kyma-meets-ccv2-hackathon-summary/storefront1.png","/images/posts/2018/kyma-meets-ccv2-hackathon-summary/storefront2.png","/images/posts/2018/kyma-meets-ccv2-hackathon-summary/diagram.png"],"content":"<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>I recently I had an opportunity to join “Kyma meets CCV2 Hackathon” in the <a href=\"https://www.sap.com/poland/index.html\" target=\"_blank\" rel=\"noopener\">SAP Labs Poland</a> office in Gliwice. The goal of the hackathon was to create a simple project, which will use <a href=\"https://github.com/kyma-project/kyma\" target=\"_blank\" rel=\"noopener\">Kyma</a> to integrate external services with the <a href=\"https://cx.sap.com/en/products/commerce\" target=\"_blank\" rel=\"noopener\">SAP Hybris Commerce Platform</a>. CCV2 stands for “Commerce Cloud Version 2”, which are basically SAP Hybris Commerce solutions deployed on the MS Azure Cloud (that’s a long story described in a short way). I joined a team consisting of people from a few different departments in the office, so we didn’t actually know each other before the event. We decided to create a simple application consisting of a few microservices, which will send an e-mail with a promotional link to the user once he or she add something to the cart in the on-line shop. After clicking on the link sent via the e-mail, user will be redirected to the front-end application, where he or she has to click on the button as many times as possible in a given period of time.</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/clickr_frontend.png\" alt=\"\"></p>\n<p>The more clicks were performed, the higher discount user will get, but not higher than 20%. When game is finished, front-end application is sending a request to the voucher service from which we can retrieve a promotional code. </p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/clickr_frontend2.png\" alt=\"\"></p>\n<p>With this code, we can go to the SAP Hybris Commerce store-front…</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/storefront1.png\" alt=\"\"></p>\n<p>…and get our discount!</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/storefront2.png\" alt=\"\"></p>\n<h2 id=\"Application-overview\"><a href=\"#Application-overview\" class=\"headerlink\" title=\"Application overview\"></a>Application overview</h2><p>General concept of the application flow is presented on the diagram below.</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/diagram.png\" alt=\"\"></p>\n<p>We decided to create three microservices:</p>\n<ul>\n<li>mailing service written in Node.js</li>\n<li>front-end application with clicking game written in JavaScript</li>\n<li>voucher service written in Kotlin</li>\n</ul>\n<p>All microservices needed to have corresponsing Docker containers, which were deployed to the Kyma instance. Kyma was communicating with SAP Hybris Commerce platform written in Java. Thanks to clear separation of a different environments, we were able to integrate services using different technologies.</p>\n<h2 id=\"Creating-a-microservice\"><a href=\"#Creating-a-microservice\" class=\"headerlink\" title=\"Creating a microservice\"></a>Creating a microservice</h2><p>I was responsible for writing voucher storage microservice. On daily basis I use Java programming language, but I wanted to try something new, so I chose Kotlin. Kotlin is a JVM language, so it runs on the same runtime as regular Java applications. Moreover, I could use tools I’m familiar with like IntelliJ, Gradle, etc. In my microservice I used <a href=\"https://gradle.org/\" target=\"_blank\" rel=\"noopener\">Gradle</a> as a build tool, <a href=\"http://javalin.io/\" target=\"_blank\" rel=\"noopener\">Javalin</a> for designing REST API and <a href=\"https://github.com/google/dagger\" target=\"_blank\" rel=\"noopener\">Dagger</a> for Dependency Injection. Moreover, for writing unit tests I used <a href=\"https://junit.org\" target=\"_blank\" rel=\"noopener\">JUnit</a>, <a href=\"https://github.com/Pragmatists/JUnitParams\" target=\"_blank\" rel=\"noopener\">JUnitParams</a>, <a href=\"https://github.com/google/truth\" target=\"_blank\" rel=\"noopener\">Truth</a> and <a href=\"https://github.com/mockito/mockito\" target=\"_blank\" rel=\"noopener\">Mockito</a>. I also wrote a few integration tests for the API with <a href=\"https://github.com/rest-assured/rest-assured\" target=\"_blank\" rel=\"noopener\">REST Assured</a>. As you can see, I could easily use Java libraries in the Kotlin application because those two languages are fully interoperable.</p>\n<p>REST API definition of my application looks pretty simple:</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">companion</span> <span class=\"keyword\">object</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> logger = LoggerFactory.getLogger(Application::<span class=\"class\"><span class=\"keyword\">class</span>.<span class=\"title\">java</span>)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> component = DaggerApplicationComponent.create()</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> voucherController = component.voucherController()</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> voucherHttpFacade = component.voucherHttpFacade()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@JvmStatic</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">main</span><span class=\"params\">(args: <span class=\"type\">Array</span>&lt;<span class=\"type\">String</span>&gt;)</span></span> &#123;</span><br><span class=\"line\">      Javalin</span><br><span class=\"line\">          .create()</span><br><span class=\"line\">          .enableCorsForAllOrigins()</span><br><span class=\"line\">          .requestLogger &#123; ctx, time -&gt;</span><br><span class=\"line\">            logger.info(<span class=\"string\">\"<span class=\"subst\">$&#123;ctx.method()&#125;</span> <span class=\"subst\">$&#123;ctx.path()&#125;</span> <span class=\"subst\">$&#123;ctx.status()&#125;</span> took <span class=\"variable\">$time</span> ms\"</span>)</span><br><span class=\"line\">          &#125;.routes &#123;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/voucher\"</span>) &#123; voucherHttpFacade.getAll(it) &#125;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/voucher/:group\"</span>) &#123; voucherHttpFacade.getGroup(it) &#125;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/health\"</span>) &#123; it.json(Health(<span class=\"string\">\"UP\"</span>)).status(HttpStatus.OK_200) &#125;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/\"</span>) &#123; it.status(HttpStatus.FORBIDDEN_403) &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          .event(JavalinEvent.SERVER_STARTING) &#123; voucherController.loadVouchers() &#125;</span><br><span class=\"line\">          .start(<span class=\"number\">7000</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>I have an endpoint for gathering all vouchers, gathering single voucher for a given group and deactivating it and health-check. In addition, I’m loading all the vouchers into the application memory on the server startup using <a href=\"https://kotlinlang.org/docs/reference/coroutines-overview.html\" target=\"_blank\" rel=\"noopener\">Kotlin coroutine</a> under the hood asynchronously.</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">loadVouchers</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  GlobalScope.async &#123; loadVouchersFromAllGroups() &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Application can be build with Gradle as follows:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./gradlew build</span><br></pre></td></tr></table></figure>\n\n<p>I’m using <a href=\"https://github.com/johnrengelman/shadow\" target=\"_blank\" rel=\"noopener\">Shadow Gradle plugin</a> to create fat jar. Once, build is finished, I can start the application with embdedded Jetty HTTP server on the port 7000.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar build/libs/app-1.0-all.jar</span><br></pre></td></tr></table></figure>\n\n<p>You can find source code of the whole application at: <a href=\"https://github.com/pwittchen/voucher-storage-service\" target=\"_blank\" rel=\"noopener\">https://github.com/pwittchen/voucher-storage-service</a>.</p>\n<h2 id=\"Deployment-of-the-microservice\"><a href=\"#Deployment-of-the-microservice\" class=\"headerlink\" title=\"Deployment of the microservice\"></a>Deployment of the microservice</h2><p>In order to deploy the microservice to the Kyma, I needed to prepare <code>Dockerfile</code>, which looks as follows:</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">8</span>-jre-alpine</span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> pwittchen</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> /app</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> build/libs/app-1.0-all.jar .</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> ls -la /app</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> java -jar app-1.0-all.jar</span></span><br></pre></td></tr></table></figure>\n\n<p>It’s just a lightweight Alpine Linux with Java 8 and Kotlin application compiled into fat jar.</p>\n<p>To build the container, I invoked command:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker build -t pwittchen/voucher-storage-service .</span><br></pre></td></tr></table></figure>\n\n<p>and to run it, I invoked command:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -p 127.0.0.1:7000:7000 -t pwittchen/voucher-storage-service</span><br></pre></td></tr></table></figure>\n\n<p>I also pushed it to the <a href=\"https://hub.docker.com/r/pwittchen/voucher-storage-service/\" target=\"_blank\" rel=\"noopener\">docker hub</a> because Kyma gets required containers from there.</p>\n<p>Next, I created <code>deployment.yml</code> file for Kubernetess, which is used by Kyma under the hood.</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">docker.io/pwittchen/voucher-storage-service:latest</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">7000</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">7000</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">voucher-storage-service</span></span><br></pre></td></tr></table></figure>\n\n<p>Such configuration had to be provided for Kyma by all microservices.</p>\n<h2 id=\"Summary\"><a href=\"#Summary\" class=\"headerlink\" title=\"Summary\"></a>Summary</h2><p>Once, we deployed all the microservices and tested the whole flow, we needed to apply a few adjustments. When issues were fixed, whole application worked correctly. This proves that external services written in different technologies can be integrated with SAP Hybris Commerce using Kyma. This hackathon was pretty nice experience, learning opportunity and productive distraction from daily projects. Moreover, our team won the whole event ex aequo with another team located in Germany. Thanks to this hackathon, I have better understanding of Kyma and integration tooling for the SAP Hybris Commerce platform.</p>\n","more":"<h2 id=\"Introduction\"><a href=\"#Introduction\" class=\"headerlink\" title=\"Introduction\"></a>Introduction</h2><p>I recently I had an opportunity to join “Kyma meets CCV2 Hackathon” in the <a href=\"https://www.sap.com/poland/index.html\" target=\"_blank\" rel=\"noopener\">SAP Labs Poland</a> office in Gliwice. The goal of the hackathon was to create a simple project, which will use <a href=\"https://github.com/kyma-project/kyma\" target=\"_blank\" rel=\"noopener\">Kyma</a> to integrate external services with the <a href=\"https://cx.sap.com/en/products/commerce\" target=\"_blank\" rel=\"noopener\">SAP Hybris Commerce Platform</a>. CCV2 stands for “Commerce Cloud Version 2”, which are basically SAP Hybris Commerce solutions deployed on the MS Azure Cloud (that’s a long story described in a short way). I joined a team consisting of people from a few different departments in the office, so we didn’t actually know each other before the event. We decided to create a simple application consisting of a few microservices, which will send an e-mail with a promotional link to the user once he or she add something to the cart in the on-line shop. After clicking on the link sent via the e-mail, user will be redirected to the front-end application, where he or she has to click on the button as many times as possible in a given period of time.</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/clickr_frontend.png\" alt=\"\"></p>\n<p>The more clicks were performed, the higher discount user will get, but not higher than 20%. When game is finished, front-end application is sending a request to the voucher service from which we can retrieve a promotional code. </p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/clickr_frontend2.png\" alt=\"\"></p>\n<p>With this code, we can go to the SAP Hybris Commerce store-front…</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/storefront1.png\" alt=\"\"></p>\n<p>…and get our discount!</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/storefront2.png\" alt=\"\"></p>\n<h2 id=\"Application-overview\"><a href=\"#Application-overview\" class=\"headerlink\" title=\"Application overview\"></a>Application overview</h2><p>General concept of the application flow is presented on the diagram below.</p>\n<p><img src=\"/images/posts/2018/kyma-meets-ccv2-hackathon-summary/diagram.png\" alt=\"\"></p>\n<p>We decided to create three microservices:</p>\n<ul>\n<li>mailing service written in Node.js</li>\n<li>front-end application with clicking game written in JavaScript</li>\n<li>voucher service written in Kotlin</li>\n</ul>\n<p>All microservices needed to have corresponsing Docker containers, which were deployed to the Kyma instance. Kyma was communicating with SAP Hybris Commerce platform written in Java. Thanks to clear separation of a different environments, we were able to integrate services using different technologies.</p>\n<h2 id=\"Creating-a-microservice\"><a href=\"#Creating-a-microservice\" class=\"headerlink\" title=\"Creating a microservice\"></a>Creating a microservice</h2><p>I was responsible for writing voucher storage microservice. On daily basis I use Java programming language, but I wanted to try something new, so I chose Kotlin. Kotlin is a JVM language, so it runs on the same runtime as regular Java applications. Moreover, I could use tools I’m familiar with like IntelliJ, Gradle, etc. In my microservice I used <a href=\"https://gradle.org/\" target=\"_blank\" rel=\"noopener\">Gradle</a> as a build tool, <a href=\"http://javalin.io/\" target=\"_blank\" rel=\"noopener\">Javalin</a> for designing REST API and <a href=\"https://github.com/google/dagger\" target=\"_blank\" rel=\"noopener\">Dagger</a> for Dependency Injection. Moreover, for writing unit tests I used <a href=\"https://junit.org\" target=\"_blank\" rel=\"noopener\">JUnit</a>, <a href=\"https://github.com/Pragmatists/JUnitParams\" target=\"_blank\" rel=\"noopener\">JUnitParams</a>, <a href=\"https://github.com/google/truth\" target=\"_blank\" rel=\"noopener\">Truth</a> and <a href=\"https://github.com/mockito/mockito\" target=\"_blank\" rel=\"noopener\">Mockito</a>. I also wrote a few integration tests for the API with <a href=\"https://github.com/rest-assured/rest-assured\" target=\"_blank\" rel=\"noopener\">REST Assured</a>. As you can see, I could easily use Java libraries in the Kotlin application because those two languages are fully interoperable.</p>\n<p>REST API definition of my application looks pretty simple:</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Application</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">companion</span> <span class=\"keyword\">object</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> logger = LoggerFactory.getLogger(Application::<span class=\"class\"><span class=\"keyword\">class</span>.<span class=\"title\">java</span>)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> component = DaggerApplicationComponent.create()</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> voucherController = component.voucherController()</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> voucherHttpFacade = component.voucherHttpFacade()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@JvmStatic</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">main</span><span class=\"params\">(args: <span class=\"type\">Array</span>&lt;<span class=\"type\">String</span>&gt;)</span></span> &#123;</span><br><span class=\"line\">      Javalin</span><br><span class=\"line\">          .create()</span><br><span class=\"line\">          .enableCorsForAllOrigins()</span><br><span class=\"line\">          .requestLogger &#123; ctx, time -&gt;</span><br><span class=\"line\">            logger.info(<span class=\"string\">\"<span class=\"subst\">$&#123;ctx.method()&#125;</span> <span class=\"subst\">$&#123;ctx.path()&#125;</span> <span class=\"subst\">$&#123;ctx.status()&#125;</span> took <span class=\"variable\">$time</span> ms\"</span>)</span><br><span class=\"line\">          &#125;.routes &#123;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/voucher\"</span>) &#123; voucherHttpFacade.getAll(it) &#125;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/voucher/:group\"</span>) &#123; voucherHttpFacade.getGroup(it) &#125;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/health\"</span>) &#123; it.json(Health(<span class=\"string\">\"UP\"</span>)).status(HttpStatus.OK_200) &#125;</span><br><span class=\"line\">            <span class=\"keyword\">get</span>(<span class=\"string\">\"/\"</span>) &#123; it.status(HttpStatus.FORBIDDEN_403) &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          .event(JavalinEvent.SERVER_STARTING) &#123; voucherController.loadVouchers() &#125;</span><br><span class=\"line\">          .start(<span class=\"number\">7000</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>I have an endpoint for gathering all vouchers, gathering single voucher for a given group and deactivating it and health-check. In addition, I’m loading all the vouchers into the application memory on the server startup using <a href=\"https://kotlinlang.org/docs/reference/coroutines-overview.html\" target=\"_blank\" rel=\"noopener\">Kotlin coroutine</a> under the hood asynchronously.</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">loadVouchers</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">  GlobalScope.async &#123; loadVouchersFromAllGroups() &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Application can be build with Gradle as follows:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./gradlew build</span><br></pre></td></tr></table></figure>\n\n<p>I’m using <a href=\"https://github.com/johnrengelman/shadow\" target=\"_blank\" rel=\"noopener\">Shadow Gradle plugin</a> to create fat jar. Once, build is finished, I can start the application with embdedded Jetty HTTP server on the port 7000.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar build/libs/app-1.0-all.jar</span><br></pre></td></tr></table></figure>\n\n<p>You can find source code of the whole application at: <a href=\"https://github.com/pwittchen/voucher-storage-service\" target=\"_blank\" rel=\"noopener\">https://github.com/pwittchen/voucher-storage-service</a>.</p>\n<h2 id=\"Deployment-of-the-microservice\"><a href=\"#Deployment-of-the-microservice\" class=\"headerlink\" title=\"Deployment of the microservice\"></a>Deployment of the microservice</h2><p>In order to deploy the microservice to the Kyma, I needed to prepare <code>Dockerfile</code>, which looks as follows:</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">8</span>-jre-alpine</span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> pwittchen</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"bash\"> /app</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"bash\"> build/libs/app-1.0-all.jar .</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> ls -la /app</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> java -jar app-1.0-all.jar</span></span><br></pre></td></tr></table></figure>\n\n<p>It’s just a lightweight Alpine Linux with Java 8 and Kotlin application compiled into fat jar.</p>\n<p>To build the container, I invoked command:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker build -t pwittchen/voucher-storage-service .</span><br></pre></td></tr></table></figure>\n\n<p>and to run it, I invoked command:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo docker run -p 127.0.0.1:7000:7000 -t pwittchen/voucher-storage-service</span><br></pre></td></tr></table></figure>\n\n<p>I also pushed it to the <a href=\"https://hub.docker.com/r/pwittchen/voucher-storage-service/\" target=\"_blank\" rel=\"noopener\">docker hub</a> because Kyma gets required containers from there.</p>\n<p>Next, I created <code>deployment.yml</code> file for Kubernetess, which is used by Kyma under the hood.</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    matchLabels:</span></span><br><span class=\"line\"><span class=\"attr\">      app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">  template:</span></span><br><span class=\"line\"><span class=\"attr\">    metadata:</span></span><br><span class=\"line\"><span class=\"attr\">      labels:</span></span><br><span class=\"line\"><span class=\"attr\">        app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">    spec:</span></span><br><span class=\"line\"><span class=\"attr\">      containers:</span></span><br><span class=\"line\"><span class=\"attr\">        - name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">          image:</span> <span class=\"string\">docker.io/pwittchen/voucher-storage-service:latest</span></span><br><span class=\"line\"><span class=\"attr\">          ports:</span></span><br><span class=\"line\"><span class=\"attr\">            - containerPort:</span> <span class=\"number\">7000</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\"><span class=\"attr\">  name:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">  labels:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">voucher-storage-service</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\"><span class=\"attr\">  ports:</span></span><br><span class=\"line\"><span class=\"attr\">  - name:</span> <span class=\"string\">http</span></span><br><span class=\"line\"><span class=\"attr\">    port:</span> <span class=\"number\">7000</span></span><br><span class=\"line\"><span class=\"attr\">  selector:</span></span><br><span class=\"line\"><span class=\"attr\">    app:</span> <span class=\"string\">voucher-storage-service</span></span><br></pre></td></tr></table></figure>\n\n<p>Such configuration had to be provided for Kyma by all microservices.</p>\n<h2 id=\"Summary\"><a href=\"#Summary\" class=\"headerlink\" title=\"Summary\"></a>Summary</h2><p>Once, we deployed all the microservices and tested the whole flow, we needed to apply a few adjustments. When issues were fixed, whole application worked correctly. This proves that external services written in different technologies can be integrated with SAP Hybris Commerce using Kyma. This hackathon was pretty nice experience, learning opportunity and productive distraction from daily projects. Moreover, our team won the whole event ex aequo with another team located in Germany. Thanks to this hackathon, I have better understanding of Kyma and integration tooling for the SAP Hybris Commerce platform.</p>\n","categories":[],"tags":[{"name":"hybris","path":"api/tags/hybris.json"},{"name":"hackathon","path":"api/tags/hackathon.json"},{"name":"kotlin","path":"api/tags/kotlin.json"},{"name":"kyma","path":"api/tags/kyma.json"},{"name":"sap","path":"api/tags/sap.json"}]}