{"title":"Updating Android XML resources before compilation via Gradle","slug":"updating-android-xml-resources-before-compilation-via-gradle","date":"2014-09-10T19:22:00.000Z","updated":"2019-07-03T22:51:02.816Z","comments":true,"path":"api/articles/updating-android-xml-resources-before-compilation-via-gradle.json","excerpt":null,"covers":null,"content":"<h2 id=\"Problem\"><a href=\"#Problem\" class=\"headerlink\" title=\"Problem\"></a>Problem</h2><p>In a team project, we encountered one of the common problems connected with mobile applications. Android application sends requests to backend web service and we donâ€™t have backend web service deployed right now on a separate server, so every mobile developer is compiling and running backend web service on the local machine for testing purposes. In the beginning, url of backend url looked as follows:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">string</span> <span class=\"attr\">name</span>=<span class=\"string\">\"backend_url\"</span>&gt;</span>192.168.1.1<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Of course address varies on different machines.</p>\n<p>When every developer was pushing changes, configuration of the backed url changed as well. It became annoying, so we decided to do something about that. </p>\n<h2 id=\"Solution-1\"><a href=\"#Solution-1\" class=\"headerlink\" title=\"Solution 1\"></a>Solution 1</h2><h3 id=\"Attempt-1\"><a href=\"#Attempt-1\" class=\"headerlink\" title=\"Attempt #1\"></a>Attempt #1</h3><p>First, we came with an idea of ignoring local changes of the XML file, which contains backend url address.<br>It can be done via Git in the following way:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git update-index --assume-unchanged [&lt;file&gt;...]</span><br></pre></td></tr></table></figure>\n\n<p>We can undo this operation with such command:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git update-index --assume-unchanged [&lt;file&gt;...]</span><br></pre></td></tr></table></figure>\n\n<p>We can also add ignored alias to our .gitconfig file:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[alias]</span><br><span class=\"line\">ignored = !git ls-files -v | grep &quot;^[[:lower:]]&quot;</span><br></pre></td></tr></table></figure>\n\n<p>Then we can type: git ignored to display ignored files.</p>\n<p>For more information check <a href=\"http://stackoverflow.com/questions/1753070/git-ignore-files-only-locally\" target=\"_blank\" rel=\"noopener\">StackOverflow discussion</a>.</p>\n<p>This solution is kind of work-around, so we decided to do it better.</p>\n<h3 id=\"Attempt-2\"><a href=\"#Attempt-2\" class=\"headerlink\" title=\"Attempt #2\"></a>Attempt #2</h3><p>We could create alias for backend url and replace it before compilation dynamically via Gradle.</p>\n<p>Our new configuration file <code>res/values/configuration.xml</code> looks like that:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">string</span> <span class=\"attr\">name</span>=<span class=\"string\">\"backend_url\"</span>&gt;</span>#const_backend_url#<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Then, our <code>build.gradle</code> file needed to be updated. The most important part starts in 29th line, where <code>#const_backend_url#</code> value is replaced with an IP address of the local machine, where mobile application is compiled. As I mentioned before, backend web service application is compiled on the same machine, so backend web service address will be proper in that case for testing purposes.</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply plugin: <span class=\"string\">'com.android.application'</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion <span class=\"number\">20</span></span><br><span class=\"line\">    buildToolsVersion <span class=\"string\">'20.0.0'</span></span><br><span class=\"line\"></span><br><span class=\"line\">    compileOptions &#123;</span><br><span class=\"line\">        <span class=\"keyword\">sourceCompatibility</span> JavaVersion.VERSION_1_7</span><br><span class=\"line\">        <span class=\"keyword\">targetCompatibility</span> JavaVersion.VERSION_1_7</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">\"com.my.app\"</span></span><br><span class=\"line\">        minSdkVersion <span class=\"number\">15</span></span><br><span class=\"line\">        targetSdkVersion <span class=\"number\">19</span></span><br><span class=\"line\">        versionCode <span class=\"number\">1</span></span><br><span class=\"line\">        versionName <span class=\"string\">\"1.0\"</span></span><br><span class=\"line\">        testInstrumentationRunner <span class=\"string\">\"com.google.android.apps.common.testing.testrunner.GoogleInstrumentationTestRunner\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    buildTypes &#123;</span><br><span class=\"line\">        release &#123;</span><br><span class=\"line\">            runProguard <span class=\"keyword\">false</span></span><br><span class=\"line\">            proguardFiles getDefaultProguardFile(<span class=\"string\">'proguard-android.txt'</span>), <span class=\"string\">'proguard-rules.pro'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// replace the #const_backend_url# with your current ip address to use your local backend web service</span></span><br><span class=\"line\">    applicationVariants.all &#123; variant -&gt;</span><br><span class=\"line\">        variant.mergeResources.<span class=\"keyword\">doLast</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">def</span> protocol = <span class=\"string\">\"https://\"</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> localIp = obtainCurrentIpAddress()</span><br><span class=\"line\">            <span class=\"keyword\">def</span> port = <span class=\"string\">\"8443\"</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> backendAddress = protocol + localIp + <span class=\"string\">\":\"</span> + port + <span class=\"string\">\"/\"</span></span><br><span class=\"line\">            <span class=\"keyword\">File</span> valuesFile = <span class=\"keyword\">file</span>(<span class=\"string\">\"$&#123;buildDir&#125;/intermediates/res/$&#123;variant.dirName&#125;/values/values.xml\"</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(valuesFile.exists()) &#123;</span><br><span class=\"line\">                String content = valuesFile.<span class=\"keyword\">getText</span>(<span class=\"string\">'UTF-8'</span>)</span><br><span class=\"line\">                content = content.replaceAll(<span class=\"string\">\"#const_backend_url#\"</span>, backendAddress)</span><br><span class=\"line\">                valuesFile.<span class=\"keyword\">write</span>(content, <span class=\"string\">'UTF-8'</span>)</span><br><span class=\"line\">                <span class=\"keyword\">println</span>(<span class=\"string\">\"Replacing #const_backend_url# with \"</span> + backendAddress + <span class=\"string\">\" in file: \"</span> + valuesFile.name)</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">println</span>(<span class=\"string\">\"File: \"</span> + valuesFile.path + <span class=\"string\">\" does not exist\"</span>)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    packagingOptions &#123;</span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/DEPENDENCIES.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LICENSE.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'LICENSE.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/NOTICE.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/NOTICE'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LICENSE'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/DEPENDENCIES'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/notice.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/license.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/dependencies.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LGPL2.1'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'ASL-2.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'LGPL-3.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/ASL-2.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LGPL-3.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/services/javax.annotation.processing.Processor'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"keyword\">fileTree</span>(dir: <span class=\"string\">'libs'</span>, <span class=\"keyword\">include</span>: [<span class=\"string\">'*.jar'</span>])</span><br><span class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"string\">'com.jakewharton:butterknife:5.1.2'</span></span><br><span class=\"line\">    <span class=\"comment\">// put your another dependencies here</span></span><br><span class=\"line\">    androidTestCompile <span class=\"string\">'com.jakewharton.espresso:espresso:1.1-r3'</span></span><br><span class=\"line\">    androidTestCompile <span class=\"string\">'com.squareup:fest-android:1.0.8'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> obtainCurrentIpAddress() &#123;</span><br><span class=\"line\">    InetAddress inetAddress = InetAddress.getLocalHost();</span><br><span class=\"line\">    <span class=\"keyword\">byte</span>[] address = inetAddress.getAddress();</span><br><span class=\"line\">    String ipAddress = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; address.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            ipAddress += <span class=\"string\">\".\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ipAddress += address[i] &amp; <span class=\"number\">0</span>xFF;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ipAddress</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Similar trick was applied in project: <a href=\"https://github.com/nenick/android-gradle-template\" target=\"_blank\" rel=\"noopener\">https://github.com/nenick/android-gradle-template</a> in file <a href=\"https://github.com/nenick/android-gradle-template/blob/master/App/build.gradle\" target=\"_blank\" rel=\"noopener\">https://github.com/nenick/android-gradle-template/blob/master/App/build.gradle</a>, so you can check it out.</p>\n","more":"<h2 id=\"Problem\"><a href=\"#Problem\" class=\"headerlink\" title=\"Problem\"></a>Problem</h2><p>In a team project, we encountered one of the common problems connected with mobile applications. Android application sends requests to backend web service and we donâ€™t have backend web service deployed right now on a separate server, so every mobile developer is compiling and running backend web service on the local machine for testing purposes. In the beginning, url of backend url looked as follows:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">string</span> <span class=\"attr\">name</span>=<span class=\"string\">\"backend_url\"</span>&gt;</span>192.168.1.1<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Of course address varies on different machines.</p>\n<p>When every developer was pushing changes, configuration of the backed url changed as well. It became annoying, so we decided to do something about that. </p>\n<h2 id=\"Solution-1\"><a href=\"#Solution-1\" class=\"headerlink\" title=\"Solution 1\"></a>Solution 1</h2><h3 id=\"Attempt-1\"><a href=\"#Attempt-1\" class=\"headerlink\" title=\"Attempt #1\"></a>Attempt #1</h3><p>First, we came with an idea of ignoring local changes of the XML file, which contains backend url address.<br>It can be done via Git in the following way:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git update-index --assume-unchanged [&lt;file&gt;...]</span><br></pre></td></tr></table></figure>\n\n<p>We can undo this operation with such command:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git update-index --assume-unchanged [&lt;file&gt;...]</span><br></pre></td></tr></table></figure>\n\n<p>We can also add ignored alias to our .gitconfig file:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[alias]</span><br><span class=\"line\">ignored = !git ls-files -v | grep &quot;^[[:lower:]]&quot;</span><br></pre></td></tr></table></figure>\n\n<p>Then we can type: git ignored to display ignored files.</p>\n<p>For more information check <a href=\"http://stackoverflow.com/questions/1753070/git-ignore-files-only-locally\" target=\"_blank\" rel=\"noopener\">StackOverflow discussion</a>.</p>\n<p>This solution is kind of work-around, so we decided to do it better.</p>\n<h3 id=\"Attempt-2\"><a href=\"#Attempt-2\" class=\"headerlink\" title=\"Attempt #2\"></a>Attempt #2</h3><p>We could create alias for backend url and replace it before compilation dynamically via Gradle.</p>\n<p>Our new configuration file <code>res/values/configuration.xml</code> looks like that:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">string</span> <span class=\"attr\">name</span>=<span class=\"string\">\"backend_url\"</span>&gt;</span>#const_backend_url#<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Then, our <code>build.gradle</code> file needed to be updated. The most important part starts in 29th line, where <code>#const_backend_url#</code> value is replaced with an IP address of the local machine, where mobile application is compiled. As I mentioned before, backend web service application is compiled on the same machine, so backend web service address will be proper in that case for testing purposes.</p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apply plugin: <span class=\"string\">'com.android.application'</span></span><br><span class=\"line\"></span><br><span class=\"line\">android &#123;</span><br><span class=\"line\">    compileSdkVersion <span class=\"number\">20</span></span><br><span class=\"line\">    buildToolsVersion <span class=\"string\">'20.0.0'</span></span><br><span class=\"line\"></span><br><span class=\"line\">    compileOptions &#123;</span><br><span class=\"line\">        <span class=\"keyword\">sourceCompatibility</span> JavaVersion.VERSION_1_7</span><br><span class=\"line\">        <span class=\"keyword\">targetCompatibility</span> JavaVersion.VERSION_1_7</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    defaultConfig &#123;</span><br><span class=\"line\">        applicationId <span class=\"string\">\"com.my.app\"</span></span><br><span class=\"line\">        minSdkVersion <span class=\"number\">15</span></span><br><span class=\"line\">        targetSdkVersion <span class=\"number\">19</span></span><br><span class=\"line\">        versionCode <span class=\"number\">1</span></span><br><span class=\"line\">        versionName <span class=\"string\">\"1.0\"</span></span><br><span class=\"line\">        testInstrumentationRunner <span class=\"string\">\"com.google.android.apps.common.testing.testrunner.GoogleInstrumentationTestRunner\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    buildTypes &#123;</span><br><span class=\"line\">        release &#123;</span><br><span class=\"line\">            runProguard <span class=\"keyword\">false</span></span><br><span class=\"line\">            proguardFiles getDefaultProguardFile(<span class=\"string\">'proguard-android.txt'</span>), <span class=\"string\">'proguard-rules.pro'</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// replace the #const_backend_url# with your current ip address to use your local backend web service</span></span><br><span class=\"line\">    applicationVariants.all &#123; variant -&gt;</span><br><span class=\"line\">        variant.mergeResources.<span class=\"keyword\">doLast</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">def</span> protocol = <span class=\"string\">\"https://\"</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> localIp = obtainCurrentIpAddress()</span><br><span class=\"line\">            <span class=\"keyword\">def</span> port = <span class=\"string\">\"8443\"</span></span><br><span class=\"line\">            <span class=\"keyword\">def</span> backendAddress = protocol + localIp + <span class=\"string\">\":\"</span> + port + <span class=\"string\">\"/\"</span></span><br><span class=\"line\">            <span class=\"keyword\">File</span> valuesFile = <span class=\"keyword\">file</span>(<span class=\"string\">\"$&#123;buildDir&#125;/intermediates/res/$&#123;variant.dirName&#125;/values/values.xml\"</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(valuesFile.exists()) &#123;</span><br><span class=\"line\">                String content = valuesFile.<span class=\"keyword\">getText</span>(<span class=\"string\">'UTF-8'</span>)</span><br><span class=\"line\">                content = content.replaceAll(<span class=\"string\">\"#const_backend_url#\"</span>, backendAddress)</span><br><span class=\"line\">                valuesFile.<span class=\"keyword\">write</span>(content, <span class=\"string\">'UTF-8'</span>)</span><br><span class=\"line\">                <span class=\"keyword\">println</span>(<span class=\"string\">\"Replacing #const_backend_url# with \"</span> + backendAddress + <span class=\"string\">\" in file: \"</span> + valuesFile.name)</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">println</span>(<span class=\"string\">\"File: \"</span> + valuesFile.path + <span class=\"string\">\" does not exist\"</span>)</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    packagingOptions &#123;</span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/DEPENDENCIES.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LICENSE.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'LICENSE.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/NOTICE.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/NOTICE'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LICENSE'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/DEPENDENCIES'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/notice.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/license.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/dependencies.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LGPL2.1'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'ASL-2.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'LGPL-3.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/ASL-2.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/LGPL-3.0.txt'</span></span><br><span class=\"line\">        <span class=\"keyword\">exclude</span> <span class=\"string\">'META-INF/services/javax.annotation.processing.Processor'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"keyword\">fileTree</span>(dir: <span class=\"string\">'libs'</span>, <span class=\"keyword\">include</span>: [<span class=\"string\">'*.jar'</span>])</span><br><span class=\"line\">    <span class=\"keyword\">compile</span> <span class=\"string\">'com.jakewharton:butterknife:5.1.2'</span></span><br><span class=\"line\">    <span class=\"comment\">// put your another dependencies here</span></span><br><span class=\"line\">    androidTestCompile <span class=\"string\">'com.jakewharton.espresso:espresso:1.1-r3'</span></span><br><span class=\"line\">    androidTestCompile <span class=\"string\">'com.squareup:fest-android:1.0.8'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> obtainCurrentIpAddress() &#123;</span><br><span class=\"line\">    InetAddress inetAddress = InetAddress.getLocalHost();</span><br><span class=\"line\">    <span class=\"keyword\">byte</span>[] address = inetAddress.getAddress();</span><br><span class=\"line\">    String ipAddress = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; address.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            ipAddress += <span class=\"string\">\".\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ipAddress += address[i] &amp; <span class=\"number\">0</span>xFF;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ipAddress</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Similar trick was applied in project: <a href=\"https://github.com/nenick/android-gradle-template\" target=\"_blank\" rel=\"noopener\">https://github.com/nenick/android-gradle-template</a> in file <a href=\"https://github.com/nenick/android-gradle-template/blob/master/App/build.gradle\" target=\"_blank\" rel=\"noopener\">https://github.com/nenick/android-gradle-template/blob/master/App/build.gradle</a>, so you can check it out.</p>\n","categories":[],"tags":[{"name":"git","path":"api/tags/git.json"},{"name":"android","path":"api/tags/android.json"},{"name":"gradle","path":"api/tags/gradle.json"}]}