<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Lifting quality of a shell script · Piotr Wittchen</title><meta name="description" content="Lifting quality of a shell script - Piotr Wittchen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400"><link rel="search" type="application/opensearchdescription+xml" href="http://wittchen.io/atom.xml" title="Piotr Wittchen"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><div>Piotr Wittchen</div></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">WRITING</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/code" target="_self" class="nav-list-link">CODE</a></li><li class="nav-list-item"><a href="/projects" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="/talks" target="_self" class="nav-list-link">TALKS</a></li><li class="nav-list-item"><a href="/contact" target="_self" class="nav-list-link">CONTACT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Lifting quality of a shell script</h1><div class="post-info">Nov 30, 2016</div><div class="post-content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In release cycle of our team at work, we need to perform so-called system tests. In order to do that, we need to log into Artifactory, search for the latest release package, check if it’s up to date, download it, unzip it, install internal configuration recipe, compile, initialize &amp; run it. Not all of that can be easily automated, but I thought that at least searching &amp; downloading phase can be done from the terminal in a semi-automated way. That’s why I created <a href="https://github.com/pwittchen/ydownloader" target="_blank" rel="noopener"><strong>ydownloader</strong></a> shell script.</p>
<h2 id="Writing-a-script-with-unit-tests-and-continuous-integration"><a href="#Writing-a-script-with-unit-tests-and-continuous-integration" class="headerlink" title="Writing a script with unit tests and continuous integration"></a>Writing a script with unit tests and continuous integration</h2><p>I’m not an expert in shell scripting, so I also wanted to learn more about it. In addition, I wanted to apply best software development practices in that script. Someone can say that in the case of a simple shell script proper engineering may be a superfluity, but in my opinion, the simplicity of the project is not an excuse for doing it the right way. Especially, if we want to use it in the future. That’s why I divided this script into smaller functions, added command line arguments handling and help for the users. Moreover, I added <a href="https://github.com/pwittchen/ydownloader/blob/master/test.sh" target="_blank" rel="noopener">unit tests</a> with <a href="https://github.com/kward/shunit2" target="_blank" rel="noopener">shunit2</a> (yes, we can write unit tests for the shell scripts) and <a href="https://travis-ci.org/pwittchen/ydownloader" target="_blank" rel="noopener">continuous integration with Travis CI</a> server. In the “Clean Code” book, we can read that code without unit tests is not clean by definition. After dividing script into smaller functions, it was much easier to test it. My script is accepting command line arguments, so I needed to do the following trick to make it testable and include it in the testing script:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$TEST_MODE</span>"</span> == <span class="string">""</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  TEST_MODE=<span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$TEST_MODE</span>"</span> = <span class="literal">false</span> ] ; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># parse command line arguments here...</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"TEST_MODE enabled"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>Then, I could write unit tests:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TEST_MODE=<span class="literal">true</span></span><br><span class="line">. ./ydownloader <span class="comment"># load script to be tested</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"RUNNING UNIT TESTS..."</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">testCutLastChars</span></span>() &#123;</span><br><span class="line">  <span class="comment"># given</span></span><br><span class="line">  valueToCut=<span class="string">'testString'</span></span><br><span class="line">  expectedValue=<span class="string">'testStri'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># when</span></span><br><span class="line">  actualValue=$(<span class="built_in">echo</span> <span class="variable">$valueToCut</span> | cutLastChars 3)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># then</span></span><br><span class="line">  assertEquals <span class="variable">$expectedValue</span> <span class="variable">$actualValue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># more tests goes here...</span></span><br><span class="line">. ./shunit2/shunit2 <span class="comment"># load shunit2</span></span><br></pre></td></tr></table></figure>

<p>There are also other solutions for unit testing like <a href="https://github.com/sstephenson/bats" target="_blank" rel="noopener">bats</a>, <a href="https://github.com/lehmannro/assert.sh" target="_blank" rel="noopener">assert.sh</a> and others. We can choose what we like. We can also use additional tools like <a href="https://github.com/joelpurra/shunit2-colorize" target="_blank" rel="noopener">shunit2-colorize</a> to make our console output of shunit2 tests look like a rainbow if we are not fans of monochromatic terminal. Moreover, we can use static code analysis tools for shell scripts like <a href="https://github.com/koalaman/shellcheck" target="_blank" rel="noopener">shellcheck</a>. In addition, I prepared simple <a href="https://github.com/pwittchen/ydownloader/blob/master/install.sh" target="_blank" rel="noopener">install script</a>, which allows to install script locally via <code>curl</code> or <code>wget</code>. Of course, project has sufficient documentation in <code>README.md</code> file.</p>
<h2 id="Short-recap"><a href="#Short-recap" class="headerlink" title="Short recap"></a>Short recap</h2><p>It was really nice coding exercise. Now, I feel much more comfortable with shell scripting, but there’s still a lot to learn. I recommend trying applying a similar approach in your scripts if you haven’t done it yet. If you want to browse complete project, check it out in my repository: <a href="https://github.com/pwittchen/ydownloader" target="_blank" rel="noopener"><strong>https://github.com/pwittchen/ydownloader</strong></a>.</p>
</div></article></div></main><footer><div class="paginator"><a href="/automate-boring-stuff/" class="prev">PREV</a><a href="/dockerizing-hybris/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'wittchenio';
var disqus_identifier = 'lifting-quality-of-a-shell-script/';
var disqus_title = 'Lifting quality of a shell script';
var disqus_url = 'http://wittchen.io/lifting-quality-of-a-shell-script/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//undefined.disqus.com/count.js" async></script><div class="copyright"><p>© 2013 - 2019 <a href="http://wittchen.io">Piotr Wittchen</a></p><p><a href="https://github.com/pwittchen/wittchen.io" target="_blank" rel="noopener">source</a> / <a href="/feed.xml">rss</a> / <a href="/archives">archives</a> / <a href="/tags">tags</a> / <a href="https://github.com/pwittchen/wittchen.io#rest" target="_blank" rel="noopener">api</a> / <a href="/gh">github</a> / <a href="/so">stackoverflow</a> / <a href="/in">linkedin</a> / <a href="mailto:piotr@wittchen.io">email</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-2194664-7",'auto');ga('send','pageview');</script></body></html>